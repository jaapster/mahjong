<html>
	<head>
		<style>
			body {
				font-family: sans-serif;
			}

			.tray {
				display: flex;
				flex-direction: row;
				padding: 12px;
				border: 1px dashed black;
				flex-wrap: wrap;
				min-height: 170px;
			}

			.tray.hovered {
				background: yellow;
			}

			.tile {
				display: flex;
				flex-direction: column;
				align-items: center;
				font-size: 11px;
				cursor: pointer;
				padding: 0;

				padding-bottom: 2px;
				background: white;
			}

			.tile:hover {
				background: rgb(233, 249, 218);
			}

			.tile .gfx {
				margin-top: -24px;
				font-size: 120px;
			}
		</style>
	</head>
	<body>
		<h1>Mahjong</h1>

		<h2>Table</h2>
		<div id="table" class="tray"></div>

		<h2>Public</h2>
		<div id="public" class="tray"></div>

		<h2>Private</h2>
		<div id="private" class="tray"></div>

		<script>
			let dragged;
			let dragSource;
			let dropTarget;

			const map = {
				public: 'a1',
				private: 'a0',
				table: 't1'
			}

			const onDragstart = (e) => {
				dragged = e.target.id;
				dragSource = e.target.parentNode.id;
			}

			const onDragOver = (e) => {
				dropTarget = e.target.id;
				event.preventDefault();
			}

			const onDragEnter = (e) => {
				const id = e.target.id;

				if (id != dragSource && map[id]) {
					e.target.classList.add('hovered');
				}

				e.preventDefault();
			}

			const onDragLeave = (e) => {
				const id = e.target.id;

				if (id != dragSource && map[id]) {
					e.target.classList.remove('hovered');
				}

				e.preventDefault();
			}

			const onDragEnd = (e) => {
				if (dropTarget) {
					if (dropTarget !== dragSource && dropTarget !== dragged) {
						fetch(`/games/${ gameId }/tiles/${ map[dragSource] }/${ dragged }?to=${ map[dropTarget] }`);
					}
				}

				document.getElementById(dropTarget).classList.remove('hovered');

				dragged = undefined;
				dragSource = undefined;
				dropTarget = undefined;
			}

			document.addEventListener('dragstart', onDragstart);
			document.addEventListener('dragover', onDragOver);
			document.addEventListener('dragend', onDragEnd);
			document.addEventListener('dragenter', onDragEnter);
			document.addEventListener('dragleave', onDragLeave);

			const g = {
				characters: {
					'1': '1F007',
					'2': '1F008',
					'3': '1F009',
					'4': '1F00A',
					'5': '1F00B',
					'6': '1F00C',
					'7': '1F00D',
					'8': '1F00E',
					'9': '1F00F',
				},
				bamboo: {
					'1': '1F010',
					'2': '1F011',
					'3': '1F012',
					'4': '1F013',
					'5': '1F014',
					'6': '1F015',
					'7': '1F016',
					'8': '1F017',
					'9': '1F018',
				},
				dots: {
					'1': '1F019',
					'2': '1F01A',
					'3': '1F01B',
					'4': '1F01C',
					'5': '1F01D',
					'6': '1F01E',
					'7': '1F01F',
					'8': '1F020',
					'9': '1F021',
				},
				flowers: {
					'plum': '1F022',
					'orchid': '1F023',
					'chrysanthemum': '1F025',
					'bamboo': '1F024'
				},
				seasons: {
					'spring': '1F022',
					'summer': '1F023',
					'autumn': '1F024',
					'winter': '1F025'
				},
				winds: {
					'east': '1F000',
					'north': '1F001',
					'west': '1F002',
					'south': '1F003'
				},
				dragons: {
					'red': '1F004',
					'green': '1F005',
					'white': '1F006'
				}
			};

			let gameId;

			const tileId = document.getElementById('tile-id');
			const fromId = document.getElementById('from-id');
			const toId = document.getElementById('to-id');
			const exec = document.getElementById('exec');
			const private = document.getElementById('private');
			const public = document.getElementById('public');
			const table = document.getElementById('table');

			const ti = (m, t) => {
				return `${ m }<div class="tile" draggable="true" id="${ t.id }"><span class="gfx">&#x${ g[t.suit][t.name] };</span><span>${ t.suit }</span><span>${ t.name }</span><span>(${ t.id })</span></div>`;
			};

			const render = (game) => {
				const pr = game.tiles.a0.reduce(ti, '');
				const pu = game.tiles.a1.reduce(ti, '');
				const ta = game.tiles.t1.reduce(ti, '');

				private.innerHTML = pr;
				public.innerHTML = pu;
				table.innerHTML = ta;
			};

			const onConnect = () => {
				fetch('/games')
					.then(response => response.json())
					.then(data => {
						game = data[0];
						gameId = game.id;

						render(game);
					});
			};

			const onGame = (game) => {
				render(game);
			};

			const stream = new EventSource('/stream');

			stream.onmessage = (event) => {
				const { id, type, data } = JSON.parse(event.data);

				if (type === 'connect') {
					onConnect();
				}

				if (type === 'game') {
					onGame(data);
				}
			};
		</script>
	</body>
</html>